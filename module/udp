#!/bin/bash

# Charge les couleurs et fonctions de base
source /etc/UDPCustom/module

# Configuration Admin
ADMIN_CONTACT="t.me/joeldata237"
VERIFY_URL="http://76.13.8.245:5000/verify"
LICENSE_FILE="/etc/udp_pro_active"

# ==================================================
#            FONCTIONS DE BASE (EXISTANTES)
# ==================================================

add_user() {
    title "CREATE USER UDP"
    print_center -ama "Create User UDP Custom"
    msg -bar
    msg -ne "Username: " && read user
    # Check if user exists
    if getent passwd $user > /dev/null 2>&1; then
        print_center -verm "User $user already exists"
        enter
        return
    fi
    msg -ne "Password: " && read pass
    msg -ne "Days Duration: " && read days
    
    useradd -M -s /bin/false -e $(date -d "+$days days" +%Y-%m-%d) $user
    echo "$user:$pass" | chpasswd
    
    print_center -verd "User Created Successfully"
    msg -bar
    msg -ama " Username: $user"
    msg -ama " Password: $pass"
    msg -ama " Expire: $(date -d "+$days days" +%Y-%m-%d)"
    enter
}

renew_user() {
    title "RENEW USER UDP"
    print_center -ama "Renew User UDP Custom"
    msg -bar
    msg -ne "Username: " && read user
    # Check if user exists
    if ! getent passwd $user > /dev/null 2>&1; then
        print_center -verm "User $user not found"
        enter
        return
    fi
    msg -ne "Days to add: " && read days
    chage -E $(date -d "+$days days" +%Y-%m-%d) $user
    print_center -verd "User Renewed Successfully"
    msg -ama " New Expiration: $(chage -l $user | grep 'Account expires' | cut -d: -f2)"
    enter
}

remove_user() {
    title "REMOVE USER UDP"
    print_center -ama "Remove User UDP Custom"
    msg -bar
    msg -ne "Username: " && read user
    if ! getent passwd $user > /dev/null 2>&1; then
        print_center -verm "User $user not found"
        enter
        return
    fi
    userdel -f $user
    print_center -verd "User $user Removed"
    enter
}

list_users() {
    title "LIST USERS UDP"
    print_center -ama "List of Users"
    msg -bar
    echo -e " \033[1;33mUSERNAME \033[1;37m| \033[1;32mEXPIRATION"
    msg -bar
    while read line; do
        u=$(echo $line | cut -d: -f1)
        exp=$(chage -l $u | grep "Account expires" | cut -d: -f2)
        echo -e " \033[1;37m$u \033[1;33m-> \033[1;32m$exp"
    done < <(grep "/bin/false" /etc/passwd)
    enter
}

# ==================================================
#            NOUVELLES FONCTIONS PRO+
# ==================================================

# 1. BOT TELEGRAM MANAGER
install_bot_pro() {
  title "ü§ñ INSTALLATION BOT TELEGRAM"
  msg -azu " Cette option va connecter votre VPS √† Telegram."
  msg -bar
  msg -ne " Entrez le Token Bot (BotFather): " && read token
  msg -ne " Entrez votre ID Admin: " && read admin_id
  
  msg -verd " Installation des d√©pendances Python..."
  apt-get install python3-pip -y > /dev/null 2>&1
  pip3 install pyTelegramBotAPI > /dev/null 2>&1

  # Cr√©ation du script Python (g√©n√©r√© dynamiquement)
  cat <<EOF > /etc/UDPCustom/udp_bot.py
import telebot
from telebot import types
import os
import subprocess

bot = telebot.TeleBot("$token")
ADMIN_ID = $admin_id

@bot.message_handler(commands=['start', 'menu'])
def menu(message):
    if message.chat.id != ADMIN_ID: return
    markup = types.InlineKeyboardMarkup(row_width=2)
    b1 = types.InlineKeyboardButton("üë• Cr√©er User", callback_data='add')
    b2 = types.InlineKeyboardButton("üóë Supprimer", callback_data='del')
    b3 = types.InlineKeyboardButton("üìã Liste", callback_data='list')
    b4 = types.InlineKeyboardButton("üìû Contact", url="https://t.me/joeldata237")
    markup.add(b1, b2, b3, b4)
    bot.reply_to(message, "üî∞ **MENU UDP MANAGER** üî∞", reply_markup=markup, parse_mode='Markdown')

@bot.callback_query_handler(func=lambda call: True)
def callback(call):
    if call.data == 'list':
        users = subprocess.getoutput("awk -F: '\$3>=1000 {print \$1}' /etc/passwd")
        bot.send_message(call.message.chat.id, f"Users:\n{users}")
    if call.data == 'add':
        msg = bot.send_message(call.message.chat.id, "Envoyez: USER PASS JOURS")
        bot.register_next_step_handler(msg, new_user)
    if call.data == 'del':
        msg = bot.send_message(call.message.chat.id, "Envoyez le USERNAME √† supprimer")
        bot.register_next_step_handler(msg, del_user)

def new_user(message):
    try:
        u, p, d = message.text.split()
        os.system(f"useradd -M -s /bin/false -e \$(date -d '+{d} days' +%Y-%m-%d) {u}")
        os.system(f"echo '{u}:{p}' | chpasswd")
        bot.reply_to(message, f"‚úÖ User {u} cr√©√© !")
    except:
        bot.reply_to(message, "‚ùå Erreur format")

def del_user(message):
    u = message.text
    os.system(f"userdel -f {u}")
    bot.reply_to(message, f"üóë User {u} supprim√© !")

bot.polling()
EOF

  # Service Systemd
  cat <<EOF > /etc/systemd/system/udp-bot.service
[Unit]
Description=UDP Bot
After=network.target
[Service]
ExecStart=/usr/bin/python3 /etc/UDPCustom/udp_bot.py
Restart=always
[Install]
WantedBy=multi-user.target
EOF
  systemctl daemon-reload && systemctl enable udp-bot && systemctl restart udp-bot
  msg -verd " ‚úÖ Bot D√©marr√© ! Allez sur Telegram."
  enter
}

# 2. MODIFIER COMPTE (Style Step-by-Step)
edit_user_pro() {
  title "‚úèÔ∏è MODIFIER UN COMPTE"
  msg -azu " Liste des utilisateurs :"
  i=1
  declare -a users
  while read line; do
      u=$(echo $line | cut -d: -f1)
      echo "  [$i] $u"
      users[$i]=$u
      ((i++))
  done < <(grep "/bin/false" /etc/passwd)
  
  msg -bar
  msg -ne " Choisissez le num√©ro : " && read num
  target=${users[$num]}
  
  if [[ -z "$target" ]]; then msg -verm " Invalide"; sleep 2; return; fi
  msg -ama " Cible : $target"

  # Step 1: Username
  msg -ne " Modifier Username ? [y/n]: " && read yn
  if [[ "$yn" == "y" ]]; then
      msg -ne " Nouveau nom : " && read new_u
      usermod -l $new_u $target
      target=$new_u
      msg -verd " Username chang√©."
  fi
  
  # Step 2: Password
  msg -ne " Modifier Password ? [y/n]: " && read yn
  if [[ "$yn" == "y" ]]; then
      msg -ne " Nouveau Pass : " && read new_p
      echo "$target:$new_p" | chpasswd
      msg -verd " Password chang√©."
  fi
  
  # Step 3: Expiration
  msg -ne " Modifier Expiration ? [y/n]: " && read yn
  if [[ "$yn" == "y" ]]; then
      msg -ne " Nouveaux Jours : " && read days
      chage -E $(date -d "+$days days" +%Y-%m-%d) $target
      msg -verd " Expiration chang√©e."
  fi
  enter
}

# 3. COMPTE TRIAL
trial_pro() {
  title "‚è±Ô∏è CR√âER COMPTE TRIAL"
  user="test$(shuf -i 100-999 -n 1)"
  pass=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 4)
  
  msg -azu " Dur√©e du test ?"
  echo " [1] 30 Minutes"
  echo " [2] 1 Heure"
  msg -ne " Choix : " && read opt
  case $opt in
     1) min=30 ;;
     2) min=60 ;;
     *) min=30 ;;
  esac
  
  useradd -M -s /bin/false $user
  echo "$user:$pass" | chpasswd
  echo "userdel -f $user" | at now + $min minutes >/dev/null 2>&1
  
  msg -bar
  msg -verd " ‚úÖ Trial Cr√©√© !"
  msg -ama " User: $user"
  msg -ama " Pass: $pass"
  msg -ama " Exp: $min Minutes"
  enter
}

# 4. ONLINE USERS
online_pro() {
  title "üü¢ UTILISATEURS EN LIGNE"
  msg -azu " Connexions actives sur le port :"
  netstat -nupt | grep udp-custom
  enter
}

# 5. VERROUILLAGE PRO+
check_license() {
    if [[ -f "$LICENSE_FILE" ]]; then
        return 0
    fi
    
    title "üîí UDP CUSTOM PRO+"
    msg -verm " Cette section est verrouill√©e."
    msg -ama " Contactez @joeldata237 pour le code."
    msg -bar
    msg -ne " Entrez le Code : " && read key
    
    # V√©rification API
    res=$(curl -s "$VERIFY_URL?key=$key")
    
    if [[ "$res" == "VALID" ]]; then
        msg -verd " ‚úÖ CODE VALIDE ! Bienvenue."
        touch "$LICENSE_FILE"
        sleep 2
        return 0
    else
        msg -verm " ‚ùå Code Invalide."
        sleep 2
        return 1
    fi
}

# ==================================================
#                  MENU PRINCIPAL
# ==================================================
udp() {
    title "JOEL DATA - UDP MANAGER V6"
    
    echo -e " \033[1;32m[1]\033[1;33m Cr√©er Utilisateur (SSH/UDP)"
    echo -e " \033[1;32m[2]\033[1;33m Supprimer Utilisateur"
    echo -e " \033[1;32m[3]\033[1;33m Renouveler Utilisateur"
    echo -e " \033[1;32m[4]\033[1;33m Liste des Utilisateurs"
    echo -e " \033[1;32m[5]\033[1;33m Infos VPS (Neofetch)"
    
    # SECTION PRO+
    if [[ -f "$LICENSE_FILE" ]]; then
        msg -bar2
        print_center -verd "--- OPTIONS PRO+ ---"
        echo -e " \033[1;36m[6]\033[1;37m Connecter Bot Telegram ü§ñ"
        echo -e " \033[1;36m[7]\033[1;37m Modifier Compte (Edit) ‚úèÔ∏è"
        echo -e " \033[1;36m[8]\033[1;37m Cr√©er Compte Trial ‚è±Ô∏è"
        echo -e " \033[1;36m[9]\033[1;37m Voir Utilisateurs En Ligne üü¢"
        echo -e " \033[1;31m[10]\033[1;37m Supprimer Licence"
    else
        msg -bar2
        echo -e " \033[1;31m[6]\033[1;33m UDP CUSTOM PRO+ (D√©bloquer) üîí"
    fi

    msg -bar
    echo -e " \033[1;31m[0]\033[1;37m Quitter"
    msg -bar
    
    # LECTURE DU CHOIX
    read -p " S√©lection : " selection
    case $selection in
        1) add_user ;;
        2) remove_user ;;
        3) renew_user ;;
        4) list_users ;;
        5) neofetch; enter ;;
        
        # LOGIQUE PRO
        6) 
            if [[ -f "$LICENSE_FILE" ]]; then install_bot_pro; else check_license && install_bot_pro; fi ;;
        7) 
            if [[ -f "$LICENSE_FILE" ]]; then edit_user_pro; else check_license && edit_user_pro; fi ;;
        8) 
            if [[ -f "$LICENSE_FILE" ]]; then trial_pro; else check_license && trial_pro; fi ;;
        9) 
            if [[ -f "$LICENSE_FILE" ]]; then online_pro; else check_license && online_pro; fi ;;
        10) 
            if [[ -f "$LICENSE_FILE" ]]; then rm "$LICENSE_FILE"; menu; fi ;;
            
        0) exit 0 ;;
        *) msg -verm "Option Invalide"; sleep 1; udp ;;
    esac
}

# Lancement du menu
udp
