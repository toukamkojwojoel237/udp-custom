#!/bin/bash

# Chargement du module graphique
source /etc/UDPCustom/module

# Configuration
ADMIN_CONTACT="t.me/joeldata237"
VERIFY_URL="http://76.13.8.245:5000/verify"
LICENSE_FILE="/etc/udp_pro_active"

# ==================================================
#            FONCTIONS DE BASE (RESTYLÃ‰ES)
# ==================================================

add_user() {
    title "CREATE USER UDP"
    print_center -ama "Create User UDP Custom"
    msg -bar
    msg -ne " Username: " && read user
    if getent passwd $user > /dev/null 2>&1; then
        print_center -verm "User $user already exists"
        enter
        return
    fi
    msg -ne " Password: " && read pass
    msg -ne " Days Duration: " && read days
    
    useradd -M -s /bin/false -e $(date -d "+$days days" +%Y-%m-%d) $user
    echo "$user:$pass" | chpasswd
    
    # LE BEAU DÃ‰COR AVEC LE PORT
    clear
    msg -bar
    print_center -verd "User Created Successfully"
    msg -bar
    msg -ama " ğŸ‘¤ Username  : $user"
    msg -ama " ğŸ”‘ Password  : $pass"
    msg -ama " ğŸ›¡ï¸ Port UDP  : 1-65535"
    msg -ama " ğŸ“… Expiry    : $(date -d "+$days days" +%Y-%m-%d)"
    msg -ama " ğŸš€ Tunneleur : UDP Custom / HTTP Custom"
    msg -bar
    enter
}

renew_user() {
    title "RENEW USER UDP"
    print_center -ama "Renew User UDP Custom"
    msg -bar
    msg -ne " Username: " && read user
    if ! getent passwd $user > /dev/null 2>&1; then
        print_center -verm "User $user not found"
        enter
        return
    fi
    msg -ne " Days to add: " && read days
    chage -E $(date -d "+$days days" +%Y-%m-%d) $user
    
    clear
    msg -bar
    print_center -verd "User Renewed Successfully"
    msg -bar
    msg -ama " ğŸ‘¤ Username  : $user"
    msg -ama " ğŸ“… New Expiry: $(chage -l $user | grep 'Account expires' | cut -d: -f2)"
    msg -bar
    enter
}

remove_user() {
    title "REMOVE USER UDP"
    print_center -ama "Remove User UDP Custom"
    msg -bar
    msg -ne " Username: " && read user
    if ! getent passwd $user > /dev/null 2>&1; then
        print_center -verm "User $user not found"
        enter
        return
    fi
    userdel -f $user
    msg -bar
    print_center -verd "User $user Removed Successfully"
    msg -bar
    enter
}

list_users() {
    title "LIST USERS UDP"
    print_center -ama "List of Users"
    msg -bar
    echo -e " \033[1;33mUSERNAME \033[1;37m| \033[1;32mEXPIRATION"
    msg -bar
    while read line; do
        u=$(echo $line | cut -d: -f1)
        exp=$(chage -l $u | grep "Account expires" | cut -d: -f2)
        echo -e " \033[1;37m$u \033[1;33m-> \033[1;32m$exp"
    done < <(grep "/bin/false" /etc/passwd)
    enter
}

# ==================================================
#            NOUVELLES FONCTIONS PRO+
# ==================================================

# 1. BOT TELEGRAM MANAGER (10 COMMANDES)
install_bot_pro() {
  title "ğŸ¤– INSTALLATION BOT TELEGRAM"
  msg -azu " Installation du Bot de Gestion Complet (10 Fonctions)."
  msg -bar
  msg -ne " Token Bot (BotFather): " && read token
  msg -ne " ID Admin Telegram: " && read admin_id
  
  msg -verd " Installation des dÃ©pendances..."
  apt-get install python3-pip -y > /dev/null 2>&1
  pip3 install pyTelegramBotAPI > /dev/null 2>&1

  # CrÃ©ation du script Python Bot (Code Complet)
  cat <<EOF > /etc/UDPCustom/udp_bot.py
import telebot
from telebot import types
import os
import subprocess
import random
import string
import datetime

TOKEN = "$token"
ADMIN_ID = $admin_id
bot = telebot.TeleBot(TOKEN)

# --- MENU PRINCIPAL ---
@bot.message_handler(commands=['start', 'menu'])
def menu(message):
    if message.chat.id != ADMIN_ID: return
    markup = types.InlineKeyboardMarkup(row_width=2)
    
    # LES 10 BOUTONS CORRESPONDANT AU SCRIPT
    b1 = types.InlineKeyboardButton("1ï¸âƒ£ CrÃ©er User", callback_data='add')
    b2 = types.InlineKeyboardButton("2ï¸âƒ£ Supprimer", callback_data='del')
    b3 = types.InlineKeyboardButton("3ï¸âƒ£ Renouveler", callback_data='renew')
    b4 = types.InlineKeyboardButton("4ï¸âƒ£ Liste Users", callback_data='list')
    b5 = types.InlineKeyboardButton("5ï¸âƒ£ Info VPS", callback_data='info')
    b6 = types.InlineKeyboardButton("6ï¸âƒ£ Modifier (Edit)", callback_data='edit')
    b7 = types.InlineKeyboardButton("7ï¸âƒ£ Trial (Test)", callback_data='trial')
    b8 = types.InlineKeyboardButton("8ï¸âƒ£ Users Online", callback_data='online')
    b9 = types.InlineKeyboardButton("9ï¸âƒ£ Aide/Contact", url="https://t.me/joeldata237")
    
    markup.add(b1, b2, b3, b4, b5, b6, b7, b8, b9)
    bot.reply_to(message, "ğŸ”° **PANEL UDP MANAGER PRO+** ğŸ”°\nSÃ©lectionnez une action :", reply_markup=markup, parse_mode='Markdown')

# --- CALLBACKS ---
@bot.callback_query_handler(func=lambda call: True)
def callback(call):
    # 4. LISTE
    if call.data == 'list':
        users = subprocess.getoutput("awk -F: '\$3>=1000 {print \$1}' /etc/passwd")
        bot.send_message(call.message.chat.id, f"ğŸ“‚ **UTILISATEURS :**\n{users}", parse_mode='Markdown')
    
    # 5. INFO
    elif call.data == 'info':
        ip = subprocess.getoutput("curl -s ipv4.icanhazip.com")
        ram = subprocess.getoutput("free -m | awk 'NR==2{printf \"%.2f%%\", \$3*100/\$2 }'")
        bot.send_message(call.message.chat.id, f"ğŸ–¥ **VPS INFO**\nIP: {ip}\nRAM: {ram}", parse_mode='Markdown')
        
    # 8. ONLINE USERS (Chiffre simple)
    elif call.data == 'online':
        # Compte les lignes netstat liÃ©es Ã  udp-custom
        count = subprocess.getoutput("netstat -nulp | grep udp-custom | wc -l")
        bot.send_message(call.message.chat.id, f"ğŸŸ¢ **En Ligne :** {count}", parse_mode='Markdown')

    # 1. ADD USER
    elif call.data == 'add':
        msg = bot.send_message(call.message.chat.id, "Envoyez: `USER PASS JOURS`\nEx: `joel 123 30`", parse_mode='Markdown')
        bot.register_next_step_handler(msg, new_user)
        
    # 2. DEL USER
    elif call.data == 'del':
        msg = bot.send_message(call.message.chat.id, "Envoyez le `USERNAME` Ã  supprimer :", parse_mode='Markdown')
        bot.register_next_step_handler(msg, del_user)
        
    # 3. RENEW
    elif call.data == 'renew':
        msg = bot.send_message(call.message.chat.id, "Envoyez: `USER JOURS_PLUS`\nEx: `joel 10`", parse_mode='Markdown')
        bot.register_next_step_handler(msg, renew_user)
        
    # 7. TRIAL
    elif call.data == 'trial':
        create_trial(call.message)

    # 6. EDIT (SimplifiÃ© pour le bot: Changer le pass)
    elif call.data == 'edit':
         msg = bot.send_message(call.message.chat.id, "Envoyez: `USER NOUVEAU_PASS`", parse_mode='Markdown')
         bot.register_next_step_handler(msg, edit_pass)

# --- FONCTIONS LOGIQUES ---
def new_user(message):
    try:
        u, p, d = message.text.split()
        os.system(f"useradd -M -s /bin/false -e \$(date -d '+{d} days' +%Y-%m-%d) {u}")
        os.system(f"echo '{u}:{p}' | chpasswd")
        
        # LE DÃ‰COR DANS LE BOT
        decor = f"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… **USER CREATED SUCCESSFULLY**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ **User:** `{u}`
ğŸ”‘ **Pass:** `{p}`
ğŸ›¡ï¸ **Port:** `1-65535`
ğŸ“… **Days:** `{d}`
ğŸš€ **Type:** `UDP Custom`
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
        bot.reply_to(message, decor, parse_mode='Markdown')
    except:
        bot.reply_to(message, "âŒ Erreur format.")

def del_user(message):
    u = message.text
    os.system(f"userdel -f {u}")
    bot.reply_to(message, f"ğŸ—‘ User `{u}` SupprimÃ© !", parse_mode='Markdown')

def renew_user(message):
    try:
        u, d = message.text.split()
        os.system(f"chage -E \$(date -d '+{d} days' +%Y-%m-%d) {u}")
        bot.reply_to(message, f"âœ… User `{u}` prolongÃ© de {d} jours.", parse_mode='Markdown')
    except:
        bot.reply_to(message, "âŒ Erreur.")

def edit_pass(message):
    try:
        u, p = message.text.split()
        os.system(f"echo '{u}:{p}' | chpasswd")
        # DÃ‰COR MODIFICATION
        decor = f"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœï¸ **USER UPDATED**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ **User:** `{u}`
ğŸ”‘ **New Pass:** `{p}`
ğŸ›¡ï¸ **Port:** `1-65535`
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
        bot.reply_to(message, decor, parse_mode='Markdown')
    except:
        bot.reply_to(message, "âŒ Erreur.")

def create_trial(message):
    u = "test" + ''.join(random.choices(string.digits, k=4))
    p = ''.join(random.choices(string.ascii_letters + string.digits, k=4))
    os.system(f"useradd -M -s /bin/false {u}")
    os.system(f"echo '{u}:{p}' | chpasswd")
    # Expire dans 30 min (via at)
    os.system(f"echo 'userdel -f {u}' | at now + 30 minutes")
    
    decor = f"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â±ï¸ **TRIAL CREATED**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ **User:** `{u}`
ğŸ”‘ **Pass:** `{p}`
ğŸ›¡ï¸ **Port:** `1-65535`
â³ **Time:** `30 Minutes`
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    bot.send_message(message.chat.id, decor, parse_mode='Markdown')

print("Bot Started...")
bot.polling()
EOF

  # Service Systemd
  cat <<EOF > /etc/systemd/system/udp-bot.service
[Unit]
Description=UDP Bot
After=network.target
[Service]
ExecStart=/usr/bin/python3 /etc/UDPCustom/udp_bot.py
Restart=always
[Install]
WantedBy=multi-user.target
EOF
  systemctl daemon-reload && systemctl enable udp-bot && systemctl restart udp-bot
  msg -verd " âœ… Bot (10 Commandes) InstallÃ© et ConnectÃ© !"
  enter
}

# 2. MODIFIER COMPTE (Step-by-Step avec DÃ©cor Final)
edit_user_pro() {
  title "âœï¸ MODIFIER UN COMPTE"
  msg -azu " Liste des utilisateurs :"
  i=1
  declare -a users
  while read line; do
      u=$(echo $line | cut -d: -f1)
      echo "  [$i] $u"
      users[$i]=$u
      ((i++))
  done < <(grep "/bin/false" /etc/passwd)
  
  msg -bar
  msg -ne " Choisissez le numÃ©ro : " && read num
  target=${users[$num]}
  
  if [[ -z "$target" ]]; then msg -verm " Invalide"; sleep 2; return; fi
  msg -ama " Cible : $target"

  # Step 1: Username
  msg -ne " Modifier Username ? [y/n]: " && read yn
  if [[ "$yn" == "y" ]]; then
      msg -ne " Nouveau nom : " && read new_u
      usermod -l $new_u $target
      target=$new_u
      msg -verd " Username changÃ©."
  fi
  
  # Step 2: Password
  msg -ne " Modifier Password ? [y/n]: " && read yn
  if [[ "$yn" == "y" ]]; then
      msg -ne " Nouveau Pass : " && read new_p
      echo "$target:$new_p" | chpasswd
      msg -verd " Password changÃ©."
      # On stocke le pass pour l'affichage final (si on le connait)
      pass_display=$new_p
  else
      pass_display="***"
  fi
  
  # Step 3: Expiration
  msg -ne " Modifier Expiration ? [y/n]: " && read yn
  if [[ "$yn" == "y" ]]; then
      msg -ne " Nouveaux Jours : " && read days
      chage -E $(date -d "+$days days" +%Y-%m-%d) $target
      msg -verd " Expiration changÃ©e."
  fi
  
  # LE DÃ‰COR FINAL DEMANDÃ‰
  clear
  msg -bar
  print_center -verd "User Modified Successfully"
  msg -bar
  msg -ama " ğŸ‘¤ Username  : $target"
  msg -ama " ğŸ”‘ Password  : $pass_display"
  msg -ama " ğŸ›¡ï¸ Port UDP  : 1-65535"
  msg -ama " ğŸ“… Expiry    : $(chage -l $target | grep 'Account expires' | cut -d: -f2)"
  msg -bar
  enter
}

# 3. COMPTE TRIAL
trial_pro() {
  title "â±ï¸ CRÃ‰ER COMPTE TRIAL"
  user="test$(shuf -i 100-999 -n 1)"
  pass=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 4)
  
  msg -azu " DurÃ©e du test ?"
  echo " [1] 30 Minutes"
  echo " [2] 1 Heure"
  msg -ne " Choix : " && read opt
  case $opt in
     1) min=30 ;;
     2) min=60 ;;
     *) min=30 ;;
  esac
  
  useradd -M -s /bin/false $user
  echo "$user:$pass" | chpasswd
  echo "userdel -f $user" | at now + $min minutes >/dev/null 2>&1
  
  clear
  msg -bar
  print_center -verd "Trial Created Successfully"
  msg -bar
  msg -ama " ğŸ‘¤ Username  : $user"
  msg -ama " ğŸ”‘ Password  : $pass"
  msg -ama " ğŸ›¡ï¸ Port UDP  : 1-65535"
  msg -ama " â³ Duration  : $min Minutes"
  msg -bar
  enter
}

# 4. ONLINE USERS (Juste le chiffre)
online_pro() {
  title "ğŸŸ¢ UTILISATEURS EN LIGNE"
  count=$(netstat -nulp | grep udp-custom | wc -l)
  msg -bar
  print_center -verd "Active Users Count"
  msg -bar
  echo -e "       \033[1;37mTotal: \033[1;32m$count"
  msg -bar
  enter
}

# 5. VERROUILLAGE PRO+
check_license() {
    if [[ -f "$LICENSE_FILE" ]]; then
        return 0
    fi
    
    title "ğŸ”’ UDP CUSTOM PRO+"
    msg -verm " Cette section est verrouillÃ©e."
    msg -ama " Contactez @joeldata237 pour le code."
    msg -bar
    msg -ne " Entrez le Code : " && read key
    
    # VÃ©rification API
    res=$(curl -s "$VERIFY_URL?key=$key")
    
    if [[ "$res" == "VALID" ]]; then
        msg -verd " âœ… CODE VALIDE ! Bienvenue."
        touch "$LICENSE_FILE"
        sleep 2
        return 0
    else
        msg -verm " âŒ Code Invalide."
        sleep 2
        return 1
    fi
}

# ==================================================
#                  MENU PRINCIPAL
# ==================================================
udp() {
    title "JOEL DATA - UDP MANAGER V7"
    
    echo -e " \033[1;32m[1]\033[1;33m CrÃ©er Utilisateur (SSH/UDP)"
    echo -e " \033[1;32m[2]\033[1;33m Supprimer Utilisateur"
    echo -e " \033[1;32m[3]\033[1;33m Renouveler Utilisateur"
    echo -e " \033[1;32m[4]\033[1;33m Liste des Utilisateurs"
    echo -e " \033[1;32m[5]\033[1;33m Infos VPS (Neofetch)"
    
    if [[ -f "$LICENSE_FILE" ]]; then
        msg -bar2
        print_center -verd "--- OPTIONS PRO+ ---"
        echo -e " \033[1;36m[6]\033[1;37m Connecter Bot Telegram ğŸ¤–"
        echo -e " \033[1;36m[7]\033[1;37m Modifier Compte (Edit) âœï¸"
        echo -e " \033[1;36m[8]\033[1;37m CrÃ©er Compte Trial â±ï¸"
        echo -e " \033[1;36m[9]\033[1;37m Voir Utilisateurs En Ligne ğŸŸ¢"
        echo -e " \033[1;31m[10]\033[1;37m Supprimer Licence"
    else
        msg -bar2
        echo -e " \033[1;31m[6]\033[1;33m UDP CUSTOM PRO+ (DÃ©bloquer) ğŸ”’"
    fi

    msg -bar
    echo -e " \033[1;31m[0]\033[1;37m Quitter"
    msg -bar
    
    read -p " SÃ©lection : " selection
    case $selection in
        1) add_user ;;
        2) remove_user ;;
        3) renew_user ;;
        4) list_users ;;
        5) neofetch; enter ;;
        
        # LOGIQUE PRO
        6) 
            if [[ -f "$LICENSE_FILE" ]]; then install_bot_pro; else check_license && install_bot_pro; fi ;;
        7) 
            if [[ -f "$LICENSE_FILE" ]]; then edit_user_pro; else check_license && edit_user_pro; fi ;;
        8) 
            if [[ -f "$LICENSE_FILE" ]]; then trial_pro; else check_license && trial_pro; fi ;;
        9) 
            if [[ -f "$LICENSE_FILE" ]]; then online_pro; else check_license && online_pro; fi ;;
        10) 
            if [[ -f "$LICENSE_FILE" ]]; then rm "$LICENSE_FILE"; menu; fi ;;
            
        0) exit 0 ;;
        *) msg -verm "Option Invalide"; sleep 1; udp ;;
    esac
}

udp
