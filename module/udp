#!/bin/bash

# Chargement du module graphique
source /etc/UDPCustom/module

# Configuration
ADMIN_CONTACT="t.me/joeldata237"
VERIFY_URL="http://127.0.0.1:5000/verify"
LICENSE_FILE="/etc/udp_pro_active"

# ==================================================
#            FONCTIONS DE BASE (BASH CLASSIQUE)
# ==================================================

add_user() {
    title "CREATE USER UDP"
    print_center -ama "Create User UDP Custom"
    msg -bar
    msg -ne " Username: " && read user
    if getent passwd $user > /dev/null 2>&1; then
        print_center -verm "User $user already exists"
        enter
        return
    fi
    msg -ne " Password: " && read pass
    msg -ne " Days Duration: " && read days
    
    useradd -M -s /bin/false -e $(date -d "+$days days" +%Y-%m-%d) $user
    echo "$user:$pass" | chpasswd
    
    clear
    msg -bar
    print_center -verd "User Created Successfully"
    msg -bar
    msg -ama " ğŸ‘¤ Username  : $user"
    msg -ama " ğŸ”‘ Password  : $pass"
    msg -ama " ğŸ›¡ï¸ Port UDP  : 1-65535"
    msg -ama " ğŸ“… Expiry    : $(date -d "+$days days" +%Y-%m-%d)"
    msg -ama " ğŸš€ Tunneleur : UDP Custom / HTTP Custom"
    msg -bar
    enter
}

renew_user() {
    title "RENEW USER UDP"
    print_center -ama "Renew User UDP Custom"
    msg -bar
    msg -ne " Username: " && read user
    if ! getent passwd $user > /dev/null 2>&1; then
        print_center -verm "User $user not found"
        enter
        return
    fi
    msg -ne " Days to add: " && read days
    chage -E $(date -d "+$days days" +%Y-%m-%d) $user
    
    clear
    msg -bar
    print_center -verd "User Renewed Successfully"
    msg -bar
    msg -ama " ğŸ‘¤ Username  : $user"
    msg -ama " ğŸ“… New Expiry: $(chage -l $user | grep 'Account expires' | cut -d: -f2)"
    msg -bar
    enter
}

remove_user() {
    title "REMOVE USER UDP"
    print_center -ama "Remove User UDP Custom"
    msg -bar
    msg -ne " Username: " && read user
    if ! getent passwd $user > /dev/null 2>&1; then
        print_center -verm "User $user not found"
        enter
        return
    fi
    userdel -f $user
    msg -bar
    print_center -verd "User $user Removed Successfully"
    msg -bar
    enter
}

list_users() {
    title "LIST USERS UDP"
    print_center -ama "List of Users"
    msg -bar
    echo -e " \033[1;33mUSERNAME \033[1;37m| \033[1;32mEXPIRATION"
    msg -bar
    while read line; do
        u=$(echo $line | cut -d: -f1)
        exp=$(chage -l $u | grep "Account expires" | cut -d: -f2)
        echo -e " \033[1;37m$u \033[1;33m-> \033[1;32m$exp"
    done < <(grep "/bin/false" /etc/passwd)
    enter
}

# ==================================================
#            FONCTIONS PRO+ (BOT AMÃ‰LIORÃ‰)
# ==================================================

install_bot_pro() {
  title "ğŸ¤– INSTALLATION BOT TELEGRAM PRO V2"
  msg -azu " Installation du Panel de Gestion UDP via Telegram."
  msg -bar
  msg -ne " Token Bot (BotFather): " && read token
  msg -ne " ID Admin Telegram: " && read admin_id
  
  # RÃ©cupÃ©ration IP pour la commande One-Liner
  vps_ip=$(curl -s ipv4.icanhazip.com)

  msg -verd " Installation des dÃ©pendances Python..."
  apt-get install python3-pip at -y > /dev/null 2>&1
  pip3 install pyTelegramBotAPI > /dev/null 2>&1

  # CRÃ‰ATION DU SCRIPT PYTHON (LE CERVEAU DU BOT)
  # Nous utilisons EOF avec quotes pour protÃ©ger le code Python
  cat << 'EOF' > /etc/UDPCustom/udp_bot.py
import telebot
from telebot import types
import os
import subprocess
import random
import string
import datetime
import time

# --- CONFIGURATION (InjectÃ©e par le script bash) ---
TOKEN = "TOKEN_PLACEHOLDER"
ADMIN_ID = ADMIN_ID_PLACEHOLDER
VPS_IP = "IP_PLACEHOLDER"
# ---------------------------------------------------

bot = telebot.TeleBot(TOKEN)

# --- FONCTIONS SYSTÃˆME ---
def run_cmd(cmd):
    return subprocess.getoutput(cmd)

def generate_pass(length=6):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))

def get_expiry_date(days):
    return (datetime.datetime.now() + datetime.timedelta(days=int(days))).strftime("%Y-%m-%d")

# --- MENU PRINCIPAL ---
def main_menu():
    markup = types.InlineKeyboardMarkup(row_width=2)
    b1 = types.InlineKeyboardButton("ğŸ‘¤ CrÃ©er User", callback_data='add_wiz')
    b2 = types.InlineKeyboardButton("ğŸ—‘ Supprimer", callback_data='del_wiz')
    b3 = types.InlineKeyboardButton("ğŸ”„ Renouveler", callback_data='renew_wiz')
    b4 = types.InlineKeyboardButton("ğŸ‘¥ Liste Users", callback_data='list')
    b5 = types.InlineKeyboardButton("â± Trial (Test)", callback_data='trial_menu')
    b6 = types.InlineKeyboardButton("ğŸŸ¢ Online", callback_data='online')
    b7 = types.InlineKeyboardButton("ğŸ–¥ Infos VPS", callback_data='info')
    markup.add(b1, b2, b3, b4, b5, b6, b7)
    return markup

@bot.message_handler(commands=['start', 'menu'])
def send_welcome(message):
    if str(message.chat.id) == str(ADMIN_ID):
        bot.reply_to(message, "ğŸ”° **JOEL DATA - UDP MANAGER** ğŸ”°\n\nBienvenue MaÃ®tre. GÃ©rez vos clients ci-dessous :", reply_markup=main_menu(), parse_mode="Markdown")

# --- GESTION DES CLICS (CALLBACKS) ---
@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    if str(call.message.chat.id) != str(ADMIN_ID): return

    # 1. MENU TRIAL
    if call.data == "trial_menu":
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("â± 30 Min", callback_data="trial:30"),
                   types.InlineKeyboardButton("â± 1 Heure", callback_data="trial:60"))
        markup.add(types.InlineKeyboardButton("ğŸ”™ Retour", callback_data="home"))
        bot.edit_message_text("â³ Choisissez la durÃ©e du test :", call.message.chat.id, call.message.message_id, reply_markup=markup)

    # 2. CRÃ‰ATION TRIAL
    elif call.data.startswith("trial:"):
        mins = int(call.data.split(":")[1])
        user = "test" + ''.join(random.choices(string.digits, k=3))
        pwd = generate_pass(4)
        
        # Commande systÃ¨me
        os.system(f"useradd -M -s /bin/false {user}")
        os.system(f"echo '{user}:{pwd}' | chpasswd")
        # Expiration auto via 'at'
        os.system(f"echo 'userdel -f {user}' | at now + {mins} minutes")
        
        # Commande Client One-Liner
        cmd_client = f"wget http://{VPS_IP}:81/udp.sh -O udp.sh && chmod +x udp.sh && ./udp.sh {user} {pwd}"
        
        decor = f"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… **COMPTE TEST ACTIVÃ‰**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ **User :** `{user}`
ğŸ”‘ **Pass :** `{pwd}`
â³ **DurÃ©e :** {mins} Minutes
ğŸ›¡ **Port :** 1-65535
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘‡ **Donnez ceci au client :**
`{cmd_client}`
"""
        bot.edit_message_text(decor, call.message.chat.id, call.message.message_id, parse_mode="Markdown")
        bot.send_message(call.message.chat.id, "Menu Principal :", reply_markup=main_menu())

    # 3. WIZARD AJOUT USER
    elif call.data == "add_wiz":
        msg = bot.send_message(call.message.chat.id, "ğŸ‘¤ Entrez le **Nom d'utilisateur** :", parse_mode="Markdown")
        bot.register_next_step_handler(msg, step_name)

    # 4. LISTE USERS
    elif call.data == "list":
        # On liste les utilisateurs qui ont /bin/false comme shell
        cmd = "awk -F: '/\/bin\/false/ {print $1}' /etc/passwd"
        users = run_cmd(cmd)
        if not users: users = "Aucun utilisateur."
        bot.edit_message_text(f"ğŸ“‚ **Utilisateurs UDP :**\n\n{users}", call.message.chat.id, call.message.message_id, parse_mode="Markdown")
        # Retour menu
        bot.send_message(call.message.chat.id, "Menu :", reply_markup=main_menu())

    # 5. INFO VPS
    elif call.data == "info":
        ram = run_cmd("free -m | awk 'NR==2{printf \"%.2f%%\", $3*100/$2 }'")
        ip = VPS_IP
        bot.answer_callback_query(call.id, f"IP: {ip} | RAM: {ram}")

    # 6. SUPPRIMER WIZARD
    elif call.data == "del_wiz":
        msg = bot.send_message(call.message.chat.id, "ğŸ—‘ Entrez le **Username** Ã  supprimer :", parse_mode="Markdown")
        bot.register_next_step_handler(msg, step_del)

    # 7. RENEW WIZARD
    elif call.data == "renew_wiz":
        msg = bot.send_message(call.message.chat.id, "ğŸ”„ Entrez le **Username** Ã  renouveler :", parse_mode="Markdown")
        bot.register_next_step_handler(msg, step_renew_name)
    
    # 8. ONLINE
    elif call.data == "online":
        count = run_cmd("netstat -nulp | grep udp-custom | wc -l")
        bot.answer_callback_query(call.id, f"Utilisateurs en ligne : {count}")

    elif call.data == "home":
        bot.edit_message_text("Menu Principal :", call.message.chat.id, call.message.message_id, reply_markup=main_menu())

# --- Ã‰TAPES (STEPS) ---
def step_name(message):
    user = message.text
    msg = bot.send_message(message.chat.id, f"User: `{user}`\nğŸ”‘ Entrez le **Mot de Passe** :", parse_mode="Markdown")
    bot.register_next_step_handler(msg, step_pass, user)

def step_pass(message, user):
    pwd = message.text
    msg = bot.send_message(message.chat.id, f"Pass: `{pwd}`\nğŸ“… Entrez la **DurÃ©e (Jours)** :", parse_mode="Markdown")
    bot.register_next_step_handler(msg, step_days, user, pwd)

def step_days(message, user, pwd):
    try:
        days = int(message.text)
        # CrÃ©ation SystÃ¨me
        os.system(f"useradd -M -s /bin/false -e $(date -d '+{days} days' +%Y-%m-%d) {user}")
        os.system(f"echo '{user}:{pwd}' | chpasswd")
        
        cmd_client = f"wget http://{VPS_IP}:81/udp.sh -O udp.sh && chmod +x udp.sh && ./udp.sh {user} {pwd}"

        decor = f"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… **UTILISATEUR CRÃ‰Ã‰**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ **User :** `{user}`
ğŸ”‘ **Pass :** `{pwd}`
ğŸ“… **Jours :** {days}
ğŸ›¡ **Port :** 1-65535
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘‡ **Donnez ceci au client :**
`{cmd_client}`
"""
        bot.send_message(message.chat.id, decor, parse_mode="Markdown", reply_markup=main_menu())
    except:
        bot.send_message(message.chat.id, "âŒ Erreur durÃ©e (chiffre requis).")

def step_del(message):
    user = message.text
    os.system(f"userdel -f {user}")
    bot.reply_to(message, f"ğŸ—‘ Utilisateur `{user}` supprimÃ©.", parse_mode="Markdown", reply_markup=main_menu())

def step_renew_name(message):
    user = message.text
    msg = bot.send_message(message.chat.id, f"User: `{user}`\nğŸ“… Combien de **Jours** ajouter ?", parse_mode="Markdown")
    bot.register_next_step_handler(msg, step_renew_days, user)

def step_renew_days(message, user):
    try:
        days = int(message.text)
        os.system(f"chage -E $(date -d '+{days} days' +%Y-%m-%d) {user}")
        bot.reply_to(message, f"âœ… `{user}` prolongÃ© de {days} jours.", parse_mode="Markdown", reply_markup=main_menu())
    except:
        bot.send_message(message.chat.id, "âŒ Erreur.")

# --- LANCEMENT ---
if __name__ == '__main__':
    print("Bot DÃ©marrÃ©...")
    bot.polling(non_stop=True)
EOF

  # Injection des variables BASH dans le fichier PYTHON
  sed -i "s/TOKEN_PLACEHOLDER/$token/g" /etc/UDPCustom/udp_bot.py
  sed -i "s/ADMIN_ID_PLACEHOLDER/$admin_id/g" /etc/UDPCustom/udp_bot.py
  sed -i "s/IP_PLACEHOLDER/$vps_ip/g" /etc/UDPCustom/udp_bot.py

  # CrÃ©ation du service Bot (Systemd)
  cat <<EOF > /etc/systemd/system/udp-bot.service
[Unit]
Description=UDP Bot Pro V2
After=network.target

[Service]
User=root
WorkingDirectory=/etc/UDPCustom
ExecStart=/usr/bin/python3 /etc/UDPCustom/udp_bot.py
Restart=always

[Install]
WantedBy=multi-user.target
EOF

  # CrÃ©ation du script client automatique (One-Liner)
  # Ce script est tÃ©lÃ©chargÃ© par le client, il utilise les arguments user/pass
  cat << 'EOF' > /etc/UDPCustom/udp.sh
#!/bin/bash
# Client Auto UDP
ARG_USER=$1
ARG_PASS=$2

if [ -z "$ARG_USER" ]; then read -p "Username: " ARG_USER; fi
if [ -z "$ARG_PASS" ]; then read -p "Password: " ARG_PASS; fi

echo -e "\033[1;32mAuthentification pour $ARG_USER..."
# Lancement du vrai installateur
wget "https://raw.githubusercontent.com/toukamkojwojoel237/udp-custom/main/install.sh" -O inst.sh && chmod +x inst.sh && ./inst.sh
# Note : L'installateur principal devra idÃ©alement Ãªtre adaptÃ© pour ne plus demander user/pass si on a dÃ©jÃ  un compte,
# mais ici Ã§a permet de lancer l'installation proprement.
EOF

  # Serveur de fichier port 81 (Pour servir le script client)
  cat <<EOF > /etc/systemd/system/udp-files.service
[Unit]
Description=File Server Port 81
After=network.target
[Service]
ExecStart=/usr/bin/python3 -m http.server 81 --directory /etc/UDPCustom
Restart=always
[Install]
WantedBy=multi-user.target
EOF

  # DÃ©marrage des services
  systemctl daemon-reload
  systemctl enable udp-bot udp-files
  systemctl restart udp-bot udp-files
  
  msg -verd " âœ… Bot V2 InstallÃ© avec succÃ¨s !"
  msg -verd " âš ï¸  Assurez-vous que le port 81 est ouvert."
  enter
}

# 4. ONLINE USERS (Fonction Bash Menu)
online_pro() {
  title "ğŸŸ¢ UTILISATEURS EN LIGNE"
  count=$(netstat -nulp | grep udp-custom | wc -l)
  msg -bar
  print_center -verd "Active Users Count"
  msg -bar
  echo -e "       \033[1;37mTotal: \033[1;32m$count"
  msg -bar
  enter
}

# 5. SYSTÃˆME DE LICENCE (SimulÃ© pour le script)
check_license() {
    if [[ -f "$LICENSE_FILE" ]]; then
        return 0
    fi
    title "ğŸ”’ UDP CUSTOM PRO+"
    msg -verm " Cette section est verrouillÃ©e."
    msg -ama " Contactez @joeldata237 pour le code."
    msg -bar
    msg -ne " Entrez le Code : " && read key
    
    if [[ "$key" == "admin123" ]]; then
        msg -verd " âœ… CODE VALIDE ! Bienvenue."
        touch "$LICENSE_FILE"
        sleep 2
        return 0
    else
        msg -verm " âŒ Code Invalide."
        sleep 2
        return 1
    fi
}

# ==================================================
#                  MENU PRINCIPAL
# ==================================================
udp() {
    title "JOEL DATA - UDP MANAGER V8"
    
    echo -e " \033[1;32m[1]\033[1;33m CrÃ©er Utilisateur (Manuel)"
    echo -e " \033[1;32m[2]\033[1;33m Supprimer Utilisateur"
    echo -e " \033[1;32m[3]\033[1;33m Renouveler Utilisateur"
    echo -e " \033[1;32m[4]\033[1;33m Liste des Utilisateurs"
    echo -e " \033[1;32m[5]\033[1;33m Infos VPS (Neofetch)"
    
    if [[ -f "$LICENSE_FILE" ]]; then
        msg -bar2
        print_center -verd "--- OPTIONS PRO+ ---"
        echo -e " \033[1;36m[6]\033[1;37m INSTALLER BOT TELEGRAM V2 ğŸ¤–"
        echo -e " \033[1;36m[7]\033[1;37m Voir Utilisateurs En Ligne ğŸŸ¢"
        echo -e " \033[1;31m[8]\033[1;37m Supprimer Licence"
    else
        msg -bar2
        echo -e " \033[1;31m[6]\033[1;33m UDP CUSTOM PRO+ (DÃ©bloquer) ğŸ”’"
    fi

    msg -bar
    echo -e " \033[1;31m[0]\033[1;37m Quitter"
    msg -bar
    
    read -p " SÃ©lection : " selection
    case $selection in
        1) add_user ;;
        2) remove_user ;;
        3) renew_user ;;
        4) list_users ;;
        5) neofetch; enter ;;
        6) 
            if [[ -f "$LICENSE_FILE" ]]; then install_bot_pro; else check_license && install_bot_pro; fi ;;
        7) 
            if [[ -f "$LICENSE_FILE" ]]; then online_pro; else check_license && online_pro; fi ;;
        8) 
            if [[ -f "$LICENSE_FILE" ]]; then rm "$LICENSE_FILE"; menu; fi ;;
            
        0) exit 0 ;;
        *) msg -verm "Option Invalide"; sleep 1; udp ;;
    esac
}

udp
